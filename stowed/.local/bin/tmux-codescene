#!/usr/bin/env bash

codescene_commands() {
    branch_worktree="$1"
    cd "$branch_worktree" || exit

    if [ "$2" != "just-build" ]; then
        cp "$CODESCENE_HOME/../config/web-profiles.clj" "$branch_worktree/cloud/web/profiles.clj" 
        cp "$CODESCENE_HOME/../config/worker-profiles.clj" "$branch_worktree/cloud/worker/profiles.clj" 
    fi

    cd ui || exit
    # Prepare all dependecies (including bootstrap).
    make deps
    npx playwright install
    npm start
}

case "$1" in
     "tmux")
         branch_name=$(basename "$2")
         clean_arg=$(echo "$branch_name" | tr '/.' '__')
         session_name=$(tmux display-message -p '#S');
         target="$session_name:$clean_arg"

         codescene="$CODESCENE_HOME/$branch_name"
         cd "$codescene" || exit 1 # Check if it exists and set $PWD for tmux's new-window.

         if ! tmux has-session -t "$target" 2>/dev/null; then
             tmux new-window -dn "$clean_arg" 
         fi

         sleep 1
         # tmux send-keys -t "$target.0" C-C Enter
         tmux send-keys -t "$target.0" "tmux-codescene $2 $3" Enter 
         ;;

     *)
         codescene_commands "$1" "$2"
         ;;
 esac
