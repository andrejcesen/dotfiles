#!/usr/bin/env bash

branch_worktree="$1"

if ! [[ -d "$branch_worktree" ]]; then
    exit 1
fi


if ! [[ -f "$branch_worktree/.envrc" ]]; then
    # Add .envrc file.
    cat <<-"EOF" > "$branch_worktree/.envrc" 
export PROOT="$PWD"
export PATH="$PWD/scripts:$PATH"
EOF
    # Explicitly allow it.
    cd "$branch_worktree"
    direnv allow
    cd -
fi

lsp_config="$branch_worktree/.lsp/config.edn" 
if [[ -f "$lsp_config" ]]; then
    cp    "$lsp_config" "$lsp_config.bak"
    # Remove root config.edn to considerably speed up lsp.
    git -C "$branch_worktree" update-index --assume-unchanged "$lsp_config"
    rm -f "$lsp_config" 
fi
