#!/usr/bin/env bash

branch_worktree="$1"

if ! [[ -d "$branch_worktree" ]]; then
    exit 1
fi

if ! [[ -f "$branch_worktree/.envrc" ]]; then
    # Add .envrc file.
    cat <<-"EOF" > "$branch_worktree/.envrc" 
export PROOT="$PWD"
export PATH="$PWD/scripts:$PATH"
EOF
    # Explicitly allow it.
    cd "$branch_worktree"
    direnv allow
    cd -
fi

lsp_config="$branch_worktree/.lsp/config.edn" 
if [[ -f "$lsp_config" ]]; then
    # Remove `:source-paths` (and use just `:cljfmt-config-path`)
    # in config.edn to considerably speed up lsp.
    # Also specify absolute path to `cljfmt.edn`, otherwise
    # lsp server might get confused when opening a nested file
    # in monorepo, causing it to not work correctly
    # (e.g. `gd` failing on ns from a different subproject etc.).
    cp "$lsp_config" "$lsp_config.bak"
    cat <<-EOF > "$lsp_config" 
{:cljfmt-config-path "$branch_worktree/cljfmt.edn"}
EOF
    git -C "$branch_worktree" update-index --skip-worktree "$lsp_config"
fi

if ! [[ -f "$branch_worktree/node_modules" ]]; then
    yarn --cwd "$branch_worktree" install
    yarn --cwd "$branch_worktree" husky install
fi
