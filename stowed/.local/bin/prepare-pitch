#!/usr/bin/env bash

branch_worktree="$1"

if ! [[ -d "$branch_worktree" ]]; then
    exit 1
fi

# Setup .envrc
if ! [[ -f "$branch_worktree/.envrc" ]]; then
    # Add .envrc file.
    cat <<-"EOF" > "$branch_worktree/.envrc" 
export PROOT="$PWD"
export PATH="$PWD/scripts:$PATH"
EOF
    # Explicitly allow it.
    cd "$branch_worktree"
    direnv allow
    cd -
fi

# Setup lsp
lsp_config="$branch_worktree/.lsp/config.edn" 
if [[ -f "$lsp_config" ]]; then
    # Remove `:source-paths` (and use just `:cljfmt-config-path`)
    # in config.edn to considerably speed up lsp.
    # Also specify absolute path to `cljfmt.edn`, otherwise
    # lsp server might get confused when opening a nested file
    # in monorepo, causing it to not work correctly
    # (e.g. `gd` failing on ns from a different subproject etc.).
    cp "$lsp_config" "$lsp_config.bak"
    cat <<-EOF > "$lsp_config" 
{:cljfmt-config-path "$branch_worktree/cljfmt.edn"}
EOF
    git -C "$branch_worktree" update-index --skip-worktree "$lsp_config"
fi

# Setup re-frisk
preload_re_frisk_cljs="$branch_worktree/mobile-app/src/shell/pitch/mobile/dev/preload_re_frisk.cljs"
if ! [[ -f "$preload_re_frisk_cljs" ]]; then
    shadow_config="$branch_worktree/mobile-app/dev/pitch/dev/main.clj"
    sed -i '' 's/re-frisk-remote.preload/pitch.mobile.dev.preload-re-frisk/g' "$shadow_config"
    git -C "$branch_worktree" update-index --skip-worktree "$shadow_config"

    # For re-frisk server to be resolved on a physical device,
    # it must be configured with a host IP, not localhost.
    local_ip=$(osascript -e "IPv4 address of (system info)")
    cat <<-EOF > "$preload_re_frisk_cljs" 
(ns pitch.mobile.dev.preload-re-frisk
  (:require [re-frisk-remote.core :as re-frisk-remote]))

(re-frisk-remote/enable {:host "$local_ip:4567"})
EOF
fi

# Setup husky
if ! [[ -f "$branch_worktree/node_modules" ]]; then
    yarn --cwd "$branch_worktree" install
    yarn --cwd "$branch_worktree" husky install
fi
